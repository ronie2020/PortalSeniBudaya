<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Guru - Portal Guru</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Inter', sans-serif; } </style>
</head>
<body>

    <!-- KONTEN SPESIFIK UNTUK HALAMAN INI -->
    <!-- Tata letak akan ditambahkan secara otomatis oleh layout.js -->
    <div class="p-6">
        <h2 id="welcome-message" class="text-3xl font-bold text-gray-800 mb-6">Memuat...</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="bg-white p-6 rounded-lg shadow"><h4 class="text-sm font-medium text-gray-500">Jumlah Siswa</h4><p id="stat-jumlah-siswa" class="text-3xl font-bold text-indigo-600 mt-2">-</p></div>
            <div class="bg-white p-6 rounded-lg shadow"><h4 class="text-sm font-medium text-gray-500">Materi Dibuat</h4><p id="stat-jumlah-materi" class="text-3xl font-bold text-green-600 mt-2">-</p></div>
            <div class="bg-white p-6 rounded-lg shadow"><h4 class="text-sm font-medium text-gray-500">Latihan Dibuat</h4><p id="stat-jumlah-latihan" class="text-3xl font-bold text-blue-600 mt-2">-</p></div>
            <div class="bg-white p-6 rounded-lg shadow"><h4 class="text-sm font-medium text-gray-500">Tugas Perlu Dinilai</h4><p id="stat-perlu-dinilai" class="text-3xl font-bold text-yellow-600 mt-2">-</p></div>
        </div>

        <div class="mt-8 grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-lg shadow"><h4 class="font-bold text-lg text-gray-800 mb-4">Materi Terbaru</h4><div id="recent-materi-list" class="space-y-3"><p class="text-gray-500">Memuat materi...</p></div></div>
                <div class="bg-white p-6 rounded-lg shadow"><h4 class="font-bold text-lg text-gray-800 mb-4">Latihan Terbaru</h4><div id="recent-latihan-list" class="space-y-3"><p class="text-gray-500">Memuat latihan...</p></div></div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow"><h4 class="font-bold text-lg text-gray-800 mb-4">Rekap Kehadiran Hari Ini</h4><div id="rekap-kehadiran-list" class="space-y-3"><p class="text-gray-500">Memuat rekap...</p></div></div>
        </div>
    </div>
    
    <!-- PENTING: Cukup impor layout.js, ia akan menangani sisanya -->
    <script type="module" src="../js/layout.js"></script>

    <!-- Skrip khusus untuk halaman ini -->
    <script type="module">
        import { supabase } from '../js/supabase-client.js';

        // Kelompokkan elemen UI agar mudah diakses
        const ui = {
            welcome: document.getElementById('welcome-message'),
            statSiswa: document.getElementById('stat-jumlah-siswa'),
            statMateri: document.getElementById('stat-jumlah-materi'),
            statLatihan: document.getElementById('stat-jumlah-latihan'),
            statNilai: document.getElementById('stat-perlu-dinilai'),
            recentMateri: document.getElementById('recent-materi-list'),
            recentLatihan: document.getElementById('recent-latihan-list'),
            rekapHadir: document.getElementById('rekap-kehadiran-list')
        };

        // Fungsi untuk menampilkan pesan error langsung di UI
        const showError = (element, message) => {
            element.innerHTML = `<p class="text-sm text-red-500">${message}</p>`;
        };

        async function fetchDashboardStats() {
            try {
                const { data, error } = await supabase.rpc('get_guru_dashboard_stats');
                if (error) throw error; // Lemparkan error untuk ditangkap oleh catch block

                if (data && data.length > 0) {
                    const stats = data[0];
                    ui.statSiswa.textContent = stats.jumlah_siswa;
                    ui.statMateri.textContent = stats.jumlah_materi;
                    ui.statLatihan.textContent = stats.jumlah_latihan;
                    ui.statNilai.textContent = stats.tugas_perlu_dinilai;
                }
            } catch (error) {
                console.error("Error fetching dashboard stats:", error);
                // Tampilkan error di semua kartu statistik
                showError(ui.statSiswa.parentElement, 'Gagal memuat statistik.');
            }
        }
        
        async function fetchRecentItems() {
            try {
                const { data: materi, error: materiError } = await supabase.from('materi').select('id, judul, kelas').order('created_at', { ascending: false }).limit(3);
                if (materiError) throw materiError;
                
                ui.recentMateri.innerHTML = '';
                if (materi.length > 0) materi.forEach(item => ui.recentMateri.innerHTML += `<a href="edit-materi.html?id=${item.id}" class="block p-3 rounded-md hover:bg-gray-100 border"><p class="font-semibold text-gray-700">${item.judul}</p><p class="text-sm text-gray-500">Kelas: ${item.kelas || 'Semua'}</p></a>`);
                else ui.recentMateri.innerHTML = '<p class="text-gray-500">Belum ada materi.</p>';

            } catch (error) {
                 console.error("Error fetching recent materi:", error);
                 showError(ui.recentMateri, 'Gagal memuat materi terbaru.');
            }

            try {
                const { data: latihan, error: latihanError } = await supabase.from('latihan').select('id, judul, kelas').order('created_at', { ascending: false }).limit(3);
                if(latihanError) throw latihanError;
                
                ui.recentLatihan.innerHTML = '';
                if (latihan.length > 0) latihan.forEach(item => ui.recentLatihan.innerHTML += `<a href="edit-latihan.html?id=${item.id}" class="block p-3 rounded-md hover:bg-gray-100 border"><p class="font-semibold text-gray-700">${item.judul}</p><p class="text-sm text-gray-500">Kelas: ${item.kelas || 'Semua'}</p></a>`);
                else ui.recentLatihan.innerHTML = '<p class="text-gray-500">Belum ada latihan.</p>';

            } catch (error) {
                console.error("Error fetching recent latihan:", error);
                showError(ui.recentLatihan, 'Gagal memuat latihan terbaru.');
            }
        }

        async function fetchRekapKehadiran() {
            try {
                const { data, error } = await supabase.rpc('get_kehadiran_hari_ini');
                if (error) throw error;

                ui.rekapHadir.innerHTML = '';
                if (data && data.length > 0) {
                    data.forEach(item => {
                        ui.rekapHadir.innerHTML += `<div class="flex justify-between items-center text-sm p-2 border-b"><span class="font-semibold text-gray-700">${item.kelas_siswa || 'Lainnya'}</span><span class="text-gray-600">${item.jumlah_hadir} Siswa Hadir</span></div>`;
                    });
                } else {
                    ui.rekapHadir.innerHTML = '<p class="text-gray-500">Belum ada absensi hari ini.</p>';
                }
            } catch(error) {
                console.error("Error fetching rekap kehadiran:", error);
                showError(ui.rekapHadir, 'Gagal memuat rekap kehadiran.');
            }
        }

        async function initializeDashboard(event) {
            const { profile } = event.detail;
            if (profile) {
                ui.welcome.textContent = `Selamat Datang, ${profile.username || profile.nama_lengkap}!`;
            }

            await Promise.all([
                fetchDashboardStats(),
                fetchRecentItems(),
                fetchRekapKehadiran()
            ]);
        }
        
        document.addEventListener('layoutReady', initializeDashboard);
    </script>
</body>
</html>

