<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manajemen Absensi - Portal Guru</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Inter', sans-serif; } </style>
</head>
<body>

    <!-- KONTEN INTI UNTUK HALAMAN INI -->
    <div class="p-6">
        <!-- Form Buat Sesi Absen -->
        <div class="bg-white p-6 rounded-lg shadow mb-8">
            <h3 class="font-bold text-lg mb-4 text-gray-800">Buat Sesi Absensi Baru</h3>
            <form id="absen-form" class="space-y-4">
                <div>
                    <label for="judul" class="block text-sm font-medium text-gray-700">Judul Sesi (Contoh: Pertemuan 1 - Seni Rupa)</label>
                    <input type="text" id="judul" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="kelas" class="block text-sm font-medium text-gray-700">Untuk Kelas</label>
                        <input type="text" id="kelas" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Contoh: 9A (Kosongkan untuk semua)">
                    </div>
                     <div>
                        <label for="deskripsi" class="block text-sm font-medium text-gray-700">Deskripsi Singkat</label>
                        <input type="text" id="deskripsi" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Kegiatan hari ini...">
                    </div>
                </div>
                <div>
                    <label for="materi" class="block text-sm font-medium text-gray-700">Materi yang Dibahas (Opsional)</label>
                    <textarea id="materi" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Sebutkan materi yang dibahas..."></textarea>
                </div>
                <div class="flex justify-end">
                    <button type="submit" id="submit-button" class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 font-semibold shadow-md transition duration-200">
                        Buat Sesi
                    </button>
                </div>
            </form>
        </div>

        <!-- Daftar Sesi Absen yang Sudah Dibuat -->
        <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="font-bold text-xl mb-4 text-gray-800">Daftar Sesi Absensi</h3>
            <div id="sesi-list" class="space-y-4">
                <p id="loading-sesi" class="text-gray-500">Memuat sesi...</p>
            </div>
        </div>
    </div>

    <!-- Panggil Layout & Skrip Halaman -->
    <script type="module" src="../js/layout.js"></script>
    <script type="module">
        import { supabase } from '../js/supabase-client.js';

        const absenForm = document.getElementById('absen-form');
        const sesiListContainer = document.getElementById('sesi-list');
        const loadingElement = document.getElementById('loading-sesi');
        let currentUser = null;

        async function handleDelete(sesiId) {
            if (confirm('Apakah Anda yakin ingin menghapus sesi absensi ini? Semua data rekapnya juga akan terhapus.')) {
                const { error } = await supabase.from('absen_sesi').delete().eq('id', sesiId);
                if (error) {
                    alert('Gagal menghapus sesi: ' + error.message);
                } else {
                    alert('Sesi berhasil dihapus.');
                    fetchSesi();
                }
            }
        }

        async function fetchSesi() {
            loadingElement.style.display = 'block';
            sesiListContainer.innerHTML = '';
            sesiListContainer.appendChild(loadingElement);

            const { data, error } = await supabase
                .from('absen_sesi')
                .select('*, absen_rekap(count)')
                .order('created_at', { ascending: false });

            loadingElement.style.display = 'none';

            if (error) {
                sesiListContainer.innerHTML = `<p class="text-red-500">Gagal memuat data: ${error.message}</p>`;
                return;
            }

            if (data.length === 0) {
                sesiListContainer.innerHTML = '<p class="text-gray-500">Belum ada sesi absensi yang dibuat.</p>';
            } else {
                data.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'border rounded-lg p-4 space-y-4 md:space-y-0 md:flex md:justify-between md:items-center';
                    const tglDibuat = new Date(item.created_at).toLocaleString('id-ID', { dateStyle: 'long', timeStyle: 'short' });
                    
                    card.innerHTML = `
                        <div class="flex-1">
                            <h4 class="font-bold text-lg text-gray-800">${item.judul}</h4>
                            <p class="text-sm text-gray-600">Kelas: <span class="font-semibold">${item.kelas || 'Semua Kelas'}</span></p>
                            <p class="text-xs text-gray-400">Dibuat: ${tglDibuat}</p>
                            <p class="mt-2 text-indigo-600 font-bold">Jumlah Siswa Hadir: ${item.absen_rekap[0]?.count || 0}</p>
                        </div>
                        <div class="flex flex-wrap gap-2 justify-start md:justify-end">
                            <a href="rekap-absen.html?id=${item.id}" class="px-3 py-2 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 transition text-sm flex items-center gap-1">Lihat Rekap</a>
                            <a href="scan-siswa.html?sesi_id=${item.id}" class="px-3 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition text-sm flex items-center gap-1">Mulai Scan</a>
                            <a href="edit-absen.html?id=${item.id}" class="px-3 py-2 bg-yellow-500 text-white font-semibold rounded-lg hover:bg-yellow-600 transition text-sm">Edit</a>
                            <button data-id="${item.id}" class="delete-btn px-3 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition text-sm">Hapus</button>
                        </div>
                    `;
                    sesiListContainer.appendChild(card);
                });

                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', (e) => handleDelete(e.target.dataset.id));
                });
            }
        }

        absenForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const submitButton = document.getElementById('submit-button');
            submitButton.disabled = true;
            submitButton.textContent = 'Membuat...';

            const { error } = await supabase.from('absen_sesi').insert({
                judul: absenForm.judul.value,
                kelas: absenForm.kelas.value || null,
                deskripsi: absenForm.deskripsi.value || null,
                materi: absenForm.materi.value || null,
                user_id: currentUser.id
            });

            if (error) {
                alert('Gagal membuat sesi: ' + error.message);
            } else {
                absenForm.reset();
                await fetchSesi();
            }
            submitButton.disabled = false;
            submitButton.textContent = 'Buat Sesi';
        });

        function initializePage(event) {
            // Data pengguna didapat dari 'layoutReady' event
            currentUser = event.detail.user;
            fetchSesi();
        }
        
        document.addEventListener('layoutReady', initializePage);
    </script>
</body>
</html>
