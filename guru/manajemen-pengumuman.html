<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Guru - Portal Guru</title>
    <link rel="icon" type="image/png" href="../assets/images/favicon.ico">  
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Inter', sans-serif; } </style>
</head>
<body class="bg-gray-100">
 <!-- KONTEN SPESIFIK UNTUK HALAMAN INI -->
    <!-- Tata letak akan ditambahkan secara otomatis oleh layout.js -->

                <!-- Content Area -->
                <div class="p-6">
                    <div class="flex justify-end mb-6">
                        <a href="tambah-pengumuman.html" class="px-5 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold shadow">
                            + Buat Pengumuman Baru
                        </a>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="font-bold text-xl mb-4 text-gray-800">Daftar Pengumuman Anda</h3>
                        <div id="pengumuman-list" class="space-y-4">
                            <p id="loading-pengumuman" class="text-gray-500">Memuat pengumuman...</p>
                        </div>
                    </div>
                </div>
    <script type="module" src="../js/layout.js"></script>
    <!-- JavaScript Logic -->
    <script type="module">
        import { supabase } from '../js/supabase-client.js';

        const displayNameElement = document.getElementById('display-name');
        const logoutButton = document.getElementById('logout-button');
        const pengumumanListContainer = document.getElementById('pengumuman-list');
        const loadingElement = document.getElementById('loading-pengumuman');

        
        // PERUBAHAN 4: Logika untuk menu hamburger
        const hamburgerBtn = document.getElementById('hamburger-btn');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');

        hamburgerBtn.addEventListener('click', () => {
            sidebar.classList.toggle('-translate-x-full');
            sidebarOverlay.style.display = sidebar.classList.contains('-translate-x-full') ? 'none' : 'block';
        });

        sidebarOverlay.addEventListener('click', () => {
            sidebar.classList.add('-translate-x-full');
            sidebarOverlay.style.display = 'none';
        });

        async function fetchPengumuman() {
            const { data, error } = await supabase
                .from('pengumuman')
                .select('*')
                .order('created_at', { ascending: false });

            loadingElement.style.display = 'none';
            pengumumanListContainer.innerHTML = '';

            if (error) {
                console.error('Error fetching pengumuman:', error);
                pengumumanListContainer.innerHTML = '<p class="text-red-500">Gagal memuat data.</p>';
                return;
            }

            if (data.length === 0) {
                pengumumanListContainer.innerHTML = '<p class="text-gray-500">Anda belum membuat pengumuman apapun.</p>';
            } else {
                data.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'border rounded-lg p-4';
                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold text-lg text-gray-800">${item.judul}</h4>
                                <p class="text-sm text-gray-500">Untuk Kelas: ${item.kelas || 'Semua Kelas'}</p>
                                <p class="text-gray-700 mt-2 whitespace-pre-wrap">${item.isi}</p>
                            </div>
                            <div class="flex space-x-3 flex-shrink-0 ml-4">
                                <a href="edit-pengumuman.html?id=${item.id}" class="text-sm text-blue-500 hover:underline font-semibold">Edit</a>
                                <button data-id="${item.id}" class="delete-btn text-sm text-red-500 hover:underline font-semibold">Hapus</button>
                            </div>
                        </div>
                    `;
                    pengumumanListContainer.appendChild(card);
                });

                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const id = e.target.dataset.id;
                        if (confirm('Apakah Anda yakin ingin menghapus pengumuman ini?')) {
                            const { error: deleteError } = await supabase.from('pengumuman').delete().eq('id', id);
                            if (deleteError) {
                                alert('Gagal menghapus: ' + deleteError.message);
                            } else {
                                fetchPengumuman();
                            }
                        }
                    });
                });
            }
        }

        async function initializePage() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                window.location.href = '/login.html';
                return;
            }
            const { data: profile } = await supabase.from('users').select('nama_lengkap').eq('id', user.id).single();
            if (profile) {
                displayNameElement.textContent = profile.nama_lengkap;
            }
            await fetchPengumuman();
        }

        logoutButton.addEventListener('click', async () => {
            await supabase.auth.signOut();
            window.location.href = '/login.html';
        });

        document.addEventListener('layoutReady', initializePage);
    </script>
</body>
</html>
