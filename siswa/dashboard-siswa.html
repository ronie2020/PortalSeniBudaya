<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Siswa - Portal Belajar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Inter', sans-serif; } </style>
</head>
<body>

    <!-- KONTEN INTI UNTUK HALAMAN INI -->
    <div class="p-6">
        <section class="mb-8">
            <h1 id="welcome-message" class="text-3xl font-bold text-gray-900 mb-2">Memuat...</h1>
            <p class="text-lg text-gray-600">Selamat belajar dan tetap semangat mengerjakan tugas-tugasmu.</p>
        </section>

        <section id="pengumuman-section" class="mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Pengumuman Terbaru</h2>
            <div id="pengumuman-list" class="space-y-4">
                <p class="text-gray-500">Memuat pengumuman...</p>
            </div>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <section>
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Tugas Perlu Dikerjakan</h2>
                <div id="tugas-list" class="space-y-4">
                    <p class="text-gray-500">Memuat tugas...</p>
                </div>
            </section>
            <section>
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Materi Terbaru</h2>
                <div id="materi-list" class="space-y-4">
                    <p class="text-gray-500">Memuat materi...</p>
                </div>
            </section>
        </div>
    </div>

    <!-- Panggil Layout & Skrip Halaman -->
    <script type="module" src="../js/layout-siswa.js"></script>
    <script type="module">
        import { supabase } from '../js/supabase-client.js';

        const welcomeMessageElement = document.getElementById('welcome-message');
        const tugasListContainer = document.getElementById('tugas-list');
        const materiListContainer = document.getElementById('materi-list');
        const pengumumanListContainer = document.getElementById('pengumuman-list');

        async function fetchAnnouncements(userProfile) {
            const { data, error } = await supabase
                .from('pengumuman')
                .select('*')
                .or(`kelas.eq.${userProfile.kelas},kelas.is.null`)
                .order('created_at', { ascending: false })
                .limit(3); 

            pengumumanListContainer.innerHTML = '';
            if (error) {
                pengumumanListContainer.innerHTML = '<p class="text-red-500">Gagal memuat pengumuman.</p>';
                return;
            }

            if (data && data.length > 0) {
                data.forEach(item => {
                    const tgl = new Date(item.created_at).toLocaleDateString('id-ID', { day: 'numeric', month: 'long' });
                    const card = document.createElement('div');
                    card.className = 'bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg';
                    card.innerHTML = `<h3 class="font-bold text-blue-800">${item.judul}</h3><p class="text-xs text-gray-500 mb-2">Diposting: ${tgl}</p><p class="text-gray-700">${item.isi}</p>`;
                    pengumumanListContainer.appendChild(card);
                });
            } else {
                document.getElementById('pengumuman-section').style.display = 'none';
            }
        }

        async function populateDashboard(currentUser, userProfile) {
            const { data: hasilSiswa } = await supabase.from('hasil_latihan').select('latihan_id').eq('user_id', currentUser.id);
            const idLatihanSudahDikerjakan = hasilSiswa ? hasilSiswa.map(h => h.latihan_id) : [];
            
            const { data: semuaLatihan } = await supabase.from('latihan').select('*').or(`kelas.eq.${userProfile.kelas},kelas.is.null`).order('batas_waktu', { ascending: true, nullsFirst: false }).limit(5);
            const latihanBelumDikerjakan = semuaLatihan ? semuaLatihan.filter(l => !idLatihanSudahDikerjakan.includes(l.id)) : [];

            tugasListContainer.innerHTML = '';
            if (latihanBelumDikerjakan.length > 0) {
                latihanBelumDikerjakan.forEach(latihan => {
                    const card = document.createElement('div');
                    card.className = 'bg-white p-4 rounded-lg shadow-sm border flex justify-between items-center';
                    let batasWaktuText = 'Tidak ada batas waktu';
                    if (latihan.batas_waktu) batasWaktuText = `Batas: ${new Date(latihan.batas_waktu).toLocaleString('id-ID')}`;
                    card.innerHTML = `<div><h3 class="font-semibold text-gray-800">${latihan.judul}</h3><p class="text-sm mt-1 text-gray-500">${batasWaktuText}</p></div><a href="kerjakan-latihan.html?id=${latihan.id}" class="px-5 py-2 bg-indigo-600 text-white text-sm font-semibold rounded-lg hover:bg-indigo-700">Kerjakan</a>`;
                    tugasListContainer.appendChild(card);
                });
            } else {
                tugasListContainer.innerHTML = '<p class="text-gray-500">Kerja bagus! Tidak ada tugas.</p>';
            }

            const { data: materi } = await supabase.from('materi').select('*').or(`kelas.eq.${userProfile.kelas},kelas.is.null`).order('created_at', { ascending: false }).limit(5);
            materiListContainer.innerHTML = '';
            if (materi && materi.length > 0) {
                materi.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'bg-white p-4 rounded-lg shadow-sm border flex justify-between items-center';
                    card.innerHTML = `<div><h3 class="font-semibold text-gray-800">${item.judul}</h3><p class="text-sm text-gray-500 mt-1">Kelas: ${item.kelas || 'Umum'}</p></div><a href="detail-materi-siswa.html?id=${item.id}" class="px-5 py-2 bg-gray-100 text-gray-700 text-sm font-semibold rounded-lg hover:bg-gray-200">Baca</a>`;
                    materiListContainer.appendChild(card);
                });
            } else {
                materiListContainer.innerHTML = '<p class="text-gray-500">Belum ada materi tersedia.</p>';
            }
        }

        function initializePage(event) {
            const { user, profile } = event.detail;
            if (profile) {
                welcomeMessageElement.textContent = `Halo, ${profile.username}!`;
                fetchAnnouncements(profile);
                populateDashboard(user, profile);
            } else {
                welcomeMessageElement.textContent = 'Gagal memuat data profil.';
            }
        }

        document.addEventListener('layoutReady', initializePage);
    </script>
</body>
</html>
